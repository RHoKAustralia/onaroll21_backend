app.controller("PostsCtrl",function(e,s,o,t,a,n,i,r){e.headTitle="posts",e.headMessage="Add a new post",e.hideFileUpload=!0,e.user=angular.fromJson(r.get("user")),e.showPostAs=!1,e.groupid=r.get("currentSelectedGroup"),e.pendingTaskDetails=angular.fromJson(r.get("pendingTaskDetails")),e.pendingTask=r.get("pendingTask"),e.imageSrc="",e.finalTask="",e.posting=!1,$(document).ready(function(){var e=navigator.userAgent.toLowerCase(),s=e.indexOf("android")>-1;s&&"true"==usingUniWebView&&$(".post-new .status_text").focusin(function(){$(this).css("height","50%")}).focusout(function(){$(this).css("height","80%")})}),e.moods=[{name:"<img src='/images/icon/emoji/fantastic.png' /> <span class='mood-title'>Fantastic</span>",code:5},{name:"<img src='/images/icon/emoji/pretty-good.png' /> <span class='mood-title'>Pretty Good</span>",code:4},{name:"<img src='/images/icon/emoji/okey.png' /> <span class='mood-title'>Okay</span>",code:3},{name:"<img src='/images/icon/emoji/not-great.png' />  <span class='mood-title'>Not Great</span>",code:2},{name:"<img src='/images/icon/emoji/terrible.png' /> <span class='mood-title'>Terrible</span>",code:1}],$("#postForm select").material_select(),s.contentWrapperLoader(),t.post("/api/mission/detectLastMission",{taskid:e.pendingTask,groupid:e.groupid}).success(function(s,o,t,a){e.finalTask=s}).error(function(e,s,o,t){}),s.removeContentWrapperLoader(),e.post={status_text:"",status_file:"",type:e.pendingTask?"mission":"general",display_mission:e.pendingTask?!0:!1,all_teams:!1,mood:""},e.modalBox=function(){$("#post-image-form").click()},e.toggleDisplayMission=function(){"mission"==e.post.type?e.post.display_mission=!0:e.post.display_mission=!1},e.showPostAsMenu=function(){},e.param={},e.file="",e.$on("fileSelected",function(s,o){e.$apply(function(){e.file=o.file,e.post.status_file=o.file;var s=new FileReader;s.onload=function(s){e.imageSrc=s.target.result,e.$apply()},s.readAsDataURL(o.file)})}),e.addPost=function(p){console.log(e.post),s.ajaxLoader(),e.post.userid=e.user.id,e.post.groupid=e.groupid,e.post.taskid=e.pendingTask?e.pendingTask:0;var l=e.post.status_text.replace(/(\r\n|\n|\r)/gm,"");a.log(e.post);var d=/^.*(vimeo\.com\/)((channels\/[A-z]+\/)|(groups\/[A-z]+\/videos\/))?([0-9]+)/;e.post.status_text?e.post.status_text&&l.search(d)>=0?(i.newDropdown("warning",5e3,"This post does not support Vimeo"),s.removeAjaxLoader()):(e.posting=!0,e.post.mood&&(e.post.mood=e.post.mood.code),n.addPost(e.post).then(function(a){e.posting=!1,"mission"==e.post.type&&(r.unset("pendingTask"),r.unset("pendingTaskDetails"),r.set("recentMissionCompleted",1),r.set("lastCompletedMission",e.post.taskid),t({url:"/api/group/list",method:"POST"}).then(function(e){r.set("numOfDaysPassed",e.data[0].daysPassed)})),e.finalTask==e.post.taskid&&e.post.mission_completed?(location.href="#/wall",setTimeout(function(){location.href="#/postsurveyintro"},3e3)):o.path("/wall"),s.removeAjaxLoader()},function(e){console.log("An upload error occured writng post"),console.log(e),appViews.progressError("An upload error has occurred.<br/>Tap to continue.")})):(i.newDropdown("warning",5e3,"Please write a message"),s.removeAjaxLoader())},e.report=function(){alert("sss")},e.switchAllteams=function(){e.post.all_teams?e.post.all_teams=!1:(e.post.all_teams=!0,e.post["private"]=!1)},e.file_changed=function(e,s){var o=document.querySelector("input[type=file]").files[0],t=o.type,a="";if(t.indexOf("image")>=0){var n=new FileReader;o&&n.readAsDataURL(o),n.onloadend=function(){$(".uploaded-image-source").attr("src",n.result),$(".uploaded-image-source").css("display","block"),$(".uploaded-images").css("display","block"),a=n.result}}else i.newDropdown("warning",5e3,"Please make sure file is picture!")},e.removePreviewImage=function(){$(".uploaded-image-source").attr("src",""),$(".uploaded-image-source").css("display","none"),$(".uploaded-images").css("display","none");var s=$(".status_file");s.replaceWith(s.val("").clone(!0)),e.post.status_file=""},alert("aaas")}),app.controller("PostEditCtrl",function(e,s,o,t,a,n,i,r,p){s.contentWrapperLoader(),e.headTitle="posts",e.headMessage="Edit a post",e.hideFileUpload=!0,e.user=angular.fromJson(p.get("user")),e.showPostAs=!1,e.groupid=p.get("currentSelectedGroup"),e.pendingTaskDetails=angular.fromJson(p.get("pendingTaskDetails")),e.pendingTask=p.get("pendingTask"),e.imageSrc="",e.finalTask="";var l="";$("#editForm select").material_select(),t.post("/api/post/fetchPostByID",{postid:p.get("postedit.id")}).success(function(o,t,a,n){e.post=o,console.log(o),1==o.mission_completed&&(e.post.type="mission"),1==o.general&&(e.post.type="general"),1==o["private"]&&(e.post.type="note"),""!=o.image&&($(".uploaded-image-source").attr("src",o.image),$(".uploaded-image-source").css("display","block"),$(".uploaded-images").css("display","block")),s.removeContentWrapperLoader()}).error(function(e,s,o,t){alert("An error ocurred !, please try again !")}),e.file_changed=function(e,s){var o=document.querySelector("input[type=file]").files[0],t=o.type;if(t.indexOf("image")>=0){var a=new FileReader;o&&a.readAsDataURL(o),a.onloadend=function(){$(".uploaded-image-source").attr("src",a.result),$(".uploaded-image-source").css("display","block"),$(".uploaded-images").css("display","block"),l=a.result}}else i.newDropdown("warning",5e3,"Please make sure file is picture!"),$(".status_file").remove(),$(".fileUpload").append('<input type="file"  onchange="angular.element(this).scope().file_changed(this)" class="status_file" data-file="post.status_file" upload-file ng-hide="hideFileUpload=0" />')},e.removePreviewImage=function(){$(".uploaded-image-source").attr("src",""),$(".uploaded-image-source").css("display","none"),$(".uploaded-images").css("display","none");var s=$(".status_file");s.replaceWith(s.val("").clone(!0)),e.post.status_file="",e.post.imgContent=""},e.report=function(){alert("sss")},e.switchAllteams=function(){e.post.all_teams?e.post.all_teams=!1:(e.post.all_teams=!0,e.post["private"]=!1)},e.editPost=function(o){console.log("ADD LOADER"),s.ajaxLoader();var t=e.post.status.replace(/(\r\n|\n|\r)/gm,""),a=/^.*(vimeo\.com\/)((channels\/[A-z]+\/)|(groups\/[A-z]+\/videos\/))?([0-9]+)/;if(e.post.status)if(e.post.status&&t.search(a)>=0)i.newDropdown("warning",5e3,"This post does not support Vimeo"),s.removeAjaxLoader();else{e.post.id=p.get("postedit.id");var n=document.querySelector("input[type=file]").files[0];console.log(n),r.http({method:"POST",url:"/api/post/submitEditedContent",headers:{"Content-Type":void 0},transformRequest:function(e){var s=new FormData;return s.append("post",angular.toJson(e.postData)),s.append("file",e.file),s},data:{postData:e.post,file:n}}).success(function(e){"OK"==e&&(location.href="#/wall",s.removeAjaxLoader())}).progress(function(e){appViews.updateProgress(parseInt(100*e.loaded/e.total))}).error(function(e,s,o,t){console.log("An error occured writng post"),console.log(e),appViews.progressError("An error has occurred.<br/>Tap to continue.")}),s.removeContentWrapperLoader(),$(".content-wrapper").fadeTo("slow",1)}else i.newDropdown("warning",5e3,"Please write a message"),s.removeAjaxLoader()}});